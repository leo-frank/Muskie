# Copyright (c) Meta Platforms, Inc. and affiliates.
# All rights reserved.
#
# This source code is licensed under the license found in the
# LICENSE file in the root directory of this source tree.

import os
import os.path as osp
import logging
import random
import glob
import pickle
import cv2
import numpy as np
from torch.utils.data import Dataset
from downstreams.utils.geometry import closed_form_inverse_se3
from downstreams.datasets.dataset_util import *
from downstreams.datasets.base_dataset import BaseDataset
import torch

seq_list = [
    "43828250", "41097978", "42897776", "42898087", "42899445", "42898936", "45261395", "44358234", "41098062", "43896558", "44358553", "42899950", "42899936", "42899055", "44358167", "42898438", "43895960", "43828435", "42897643", "43895892", "42898942", "41098186", "43896183", "41048242", "42899285", "43828584", "44358341", "40958737", "43896362", "42898023", "44358225", "43896510", "42898530", "42899318", "43895884", "41125120", "45261486", "44358575", "42898571", "42899517", "42898762", "42899268", "41125111", "43895904", "44358630", "41069098", "42899448", "41125085", "43896487", "43828230", "43828504", "45261096", "42898500", "42899582", "42898109", "42899861", "43828320", "41069178", "45663052", "41125011", "41007603", "43896186", "42898120", "42899756", "41048180", "42899483", "44358278", "42898070", "41048074", "45261452", "41048225", "45261544", "42899801", "43828457", "42898655", "43896126", "43896452", "42899020", "44358594", "41048190", "41098042", "42898345", "42898340", "42898751", "45260892", "45662831", "43896018", "44358419", "41098144", "42897892", "45261641", "44358361", "42898612", "42897846", "45261495", "42899953", "41125064", "42899141", "42897583", "42897851", "42899584", "42898071", "44358328", "41007591", "42898372", "42897634", "42898711", "42897911", "43828233", "42899317", "43828360", "42899490", "42897986", "42897830", "45261324", "44358576", "42897625", "42897822", "42898009", "43896446", "42899778", "42898163", "43896516", "42899292", "42897875", "42897798", "42899513", "42898376", "42899765", "44358407", "42898714", "42899653", "45260895", "42897607", "41048236", "41125106", "43828421", "43896515", "43896418", "42899654", "45261541", "42897921", "42898388", "42899307", "43895978", "43896321", "42899041", "44358338", "42898166", "42898461", "42898629", "42897939", "45261027", "43828340", "45662956", "42899215", "40776204", "42898765", "45261357", "43896264", "43828496", "41125294", "45261331", "45662886", "42898135", "45261290", "44358105", "43828390", "45261392", "40777065", "43896121", "42899432", "43896545", "42897785", "41069117", "41098178", "43828369", "45663312", "42899666", "45261024", "45260877", "43896330", "44358253", "43828231", "41124934", "42898248", "45261343", "42899336", "44358336", "44358561", "41124848", "42898171", "42897405", "43896117", "42898050", "42899184", "40753686", "45260890", "42897802", "43895975", "45261100", "44358617", "41098190", "42898990", "43896477", "44358281", "45663065", "41069085", "41007602", "43828572", "44358373", "43895912", "43896280", "45662812", "42899822", "42899532", "41048083", "42897681", "42897490", "41125388", "45662847", "45260999", "41098151", "42898182", "45261000", "42899924", "44358360", "44358235", "43896416", "41124918", "42898958", "44358118", "41098066", "41069168", "42898458", "44358162", "42898722", "42897898", "45662813", "45260951", "41125248", "42899111", "42899019", "42899295", "42899811", "42898391", "42899316", "42899535", "42898132", "43896042", "45261397", "43896412", "42898972", "42899455", "41069181", "44358599", "42897756", "42899021", "43828554", "42897955", "42899603", "42899800", "42898738", "43896066", "44358719", "43896020", "45662884", "42898710", "44358257", "43828587", "41048158", "43828324", "42897868", "41125543", "44358718", "42899340", "43896187", "42897744", "42899799", "43896365", "42897936", "41125469", "41069053", "43896568", "42898332", "43896216", "44358480", "42898386", "42898622", "44358386", "42899140", "42898979", "43896371", "44358574", "45261533", "43896567", "43828311", "42898510", "42897982", "43896231", "42899046", "42897590", "42897653", "42899202", "42898097", "43896217", "41098157", "42899851", "42898420", "42899775", "43895908", "42898169", "42897973", "41069140", "45261329", "44358295", "43896539", "41048231", "45261355", "41125199", "43895920", "41048120", "42898442", "42898123", "42899624", "40753679", "40777060", "43896589", "42898041", "41125262", "45260947", "41098166", "45260981", "42899900", "42897783", "43896518", "43895896", "42898472", "42899233", "43896263", "43828439", "41098001", "41048071", "42899353", "41098184", "44358243", "42899642", "43896019", "42897455", "42898059", "42897442", "42897452", "43896260", "42899906", "44358263", "42898555", "41069111", "42899305", "45261515", "43895938", "43896419", "42899542", "44358170", "42898679", "43896551", "45662796", "43896096", "41098005", "43895949", "42898261", "45261108", "42897482", "42897815", "44358540", "45261507", "42899543", "45662995", "44358557", "43896467", "45261485", "43828380", "42897598", "44358302", "42899920", "43895977", "41098145", "42899886", "43896196", "43828571", "43896205", "45260957", "44358121", "41098162", "41125508", "43896024", "44358423", "42899975", "42898419", "44358428", "43828339", "42898903", "42898358", "45662908", "42898689", "42897739", "43828272", "41124913", "43895886", "43896469", "42899828", "42898621", "42899529", "41098103", "45261381", "42898808", "42898653", "42899912", "42897890", "42899643", "41007581", "42898427", "41069135", "45261313", "42898379", "41098191", "42899128", "42899763", "42897418", "44358256", "41048085", "42897537", "45662950", "42899220", "42897467", "42898930", "42899913", "42899533", "44358173", "42898560", "42899474", "44358340", "45261099", "42898024", "41069099", "42899154", "41125303", "45663258", "42899435", "42899664", "42899125", "44358729", "45261600", "42898587", "42897888", "42897757", "43828382", "42898235", "45662959", "42898094", "45261344", "42898668", "44358204", "44358564", "45663007", "42898971", "42898616", "43896229", "41097994", "44358270", "43895995", "42899360", "44358176", "42897960", "42899593", "42898917", "42899034", "45261061", "42899650", "41097983", "42897712", "41069161", "42898526", "45663010", "42898374", "43896244", "43896527", "41254934", "42897622", "42899817", "43828593", "42897410", "45261323", "45662829", "43896038", "42897709", "42899137", "42899887", "40777073", "42898098", "42899280", "43896347", "41125316", "44358378", "41069146", "42899577", "40958756", "41048097", "41007590", "45261571", "42897509", "44358238", "42899860", "43896466", "45261455", "42897737", "42899866", "42898215", "43896432", "43896251", "44358227", "43828586", "42897419", "41069162", "43896517", "45662897", "42899598", "42897755", "42898213", "42897769", "41098141", "42897560", "43828334", "42898477", "41048147", "43896170", "42899162", "42898447", "42898021", "45663044", "42899211", "42899774", "42898716", "40777069", "44358661", "43896346", "41069144", "45662998", "43896160", "42899428", "41254925", "43896491", "42899065", "42897951", "43896494", "44358259", "45261059", "42898393", "44358673", "42898966", "42899574", "44358593", "43896538", "42897840", "45261384", "43896351", "41048265", "44358691", "41098182", "45662962", "42898720", "42897870", "42899245", "42897600", "42899844", "42898684", "42898370", "44358380", "41098139", "44358426", "42897722", "41125135", "44358117", "42899498", "43828456", "43896075", "42899559", "42897877", "42899198", "41124923", "42898160", "42899139", "40776203", "41048223", "43896429", "42898977", "43828150", "45662870", "44358731", "42898392", "40777079", "41125272", "42898983", "43896536", "42899944", "42897876", "42898676", "45662996", "41069088", "42897434", "43896482", "42899175", "45663053", "42899569", "41007608", "44358258", "45261527", "42897818", "43828552", "43896384", "42899043", "42898052", "41048169", "44358620", "44358306", "45261042", "42899563", "42897738", "40809741", "45261078", "44358222", "42899550", "42898715", "45261089", "42897849", "42898577", "42897668", "42899668", "43896576", "42897439", "41125040", "42899024", "43896522", "41069054", "42899118", "41069157", "42899433", "42899053", "42899119", "44358693", "43895943", "41069142", "41125438", "45261490", "42899265", "42899327", "41069164", "42899216", "42899112", "43896177", "44358473", "42899849", "45261326", "44358324", "41048093", "42898221", "41048124", "42899210", "43828476", "45663009", "42898203", "45261066", "44358345", "42898696", "42899968", "42898785", "43896202", "42898348", "42898334", "44358291", "42898551", "42898937", "42899003", "44358252", "43828168", "41048264", "43896069", "43828464", "42898976", "41097991", "42898349", "41098076", "43896326", "42899951", "42898756", "43828328", "45662891", "42898680", "42897422", "44358624", "43828351", "43896395", "43896010", "42898045", "42897996", "42899311", "42898633", "42898651", "42897772", "44358333", "42899797", "42897804", "43828323", "42898112", "45663262", "43895994", "43828270", "42899922", "41069115", "43896344", "41124801", "43896358", "43828307", "41098106", "45261645", "43828261", "42897967", "44358241", "45662912", "41069055", "43828245", "43828252", "42898677", "43828154", "41069093", "43828366", "42899333", "42898256", "45260872", "42899358", "43828345", "43895956", "42899970", "44358720", "44358230", "43895895", "42899165", "42898618", "42899120", "41125536", "42898100", "45261064", "42897745", "44358472", "45261317", "44358389", "45261080", "42899452", "43896461", "43828555", "41007582", "43896379", "43896282", "42897512", "43896512", "42898125", "43828420", "42899235", "42899439", "42899287", "42898377", "41125501", "42899232", "45260984", "42897771", "41098045", "42899300", "45662835", "42897859", "42898671", "43828460", "41048142", "44358631", "42899126", "42899011", "43896449", "42899282", "44358460", "42898230", "43828405", "42898212", "42899630", "45662960", "42899178", "42899955", "42898686", "42899854", "41048182", "42897713", "45260873", "42899324", "43896339", "41069080", "43896035", "42898959", "43828423", "42899573", "42899829", "41125285", "42899027", "45261054", "44358289", "45261601", "40966448", "43828564", "45261087", "44358327", "42899109", "41098061", "43828262", "42898065", "42899312", "42899864", "41097992", "42898712", "42897780", "42899022", "45663051", "45662826", "45261339", "43828368", "42898037", "45261035", "42898938", "42897479", "45261562", "45261524", "44358710", "43896234", "40958754", "45261378", "42898541", "42899596", "42898046", "42898687", "42898988", "43828391", "45261406", "44358728", "44358567", "45261565", "42897947", "45261522", "42899477", "42899132", "41098100", "43895919", "42899515", "42898791", "42898247", "41124857", "43896232", "41048193", "45261555", "42897595", "42898752", "42898234", "41124824", "43828507", "42899526", "45662800", "42899060", "45261008", "41048229", "41048129", "42899789", "42898740", "42897735", "43828486", "42898439", "45662846", "42898792", "43828576", "43896556", "41125124", "43896484", "42898511", "44358700", "42899935", "42897916", "43828138", "45261010", "42897759", "42898470", "43828498", "41124891", "43895921", "42898454", "44358362", "43896063", "42899430", "41069072", "43828478", "42898337", "45261314", "42897928", "42898254", "45260952", "42897913", "42898057", "40958733", "44358406", "41125451", "40958749", "43895911", "44358596", "41048246", "42897829", "43896308", "42899768", "45261598", "45662809", "42899313", "42898444", "42899271", "42898156", "45261547", "41254954", "42898190", "42898384", "42898941", "41048262", "42899600", "45261332", "45663064", "45663255", "43896224", "41045408", "42898701", "42899209", "43828404", "44358418", "42899352", "42897925", "42899753", "42898984", "43896327", "42899168", "42899760", "42899453", "40958764", "42897934", "42899243", "43896378", "42899767", "41125483", "42898407", "42897720", "42898899", "43896332", "43895917", "42899185", "41048143", "42897863", "42898728", "44358634", "42897631", "42899916", "43828149", "43895946", "41098140", "41069125", "43896103", "42897426", "42899161", "41097986", "42899236", "42898723", "42897677", "42899067", "45662806", "42899511", "42898667", "42899977", "41097984", "42897971", "43828243", "42897675", "42898754", "45662805", "43828493", "42899879", "43896386", "42899248", "40958767", "42899422", "42899489", "45260891", "45261509", "43895868", "42897655", "43896101", "41098169", "42897633", "45662791", "42898189", "42899640", "42898342", "43896031", "43828517", "42898506", "42898931", "42898364", "43828265", "43828381", "42899657", "43828583", "42897478", "43896354", "41254940", "43896122", "43896083", "42899057", "43896176", "43896174", "44358112", "44358627", "42898360", "44358212", "44358220", "42897924", "41007548", "42897945", "41098171", "42899819", "42899957", "43896478", "42899909", "44358471", "42898250", "45662882", "44358698", "42898801", "43828162", "42899063", "42899071", "42899525", "45663248", "45261651", "41098093", "42899632", "42898366", "42898558", "41098158", "43828505", "42899486", "42898796", "42898089", "42897930", "42899214", "43896043", "42898799", "42898786", "45261548", "43828506", "42898729", "41069076", "43828565", "42899221", "42899364", "43896284", "42897931", "41124839", "45261556", "42899567", "41048159", "42898350", "43896587", "43895969", "42897728", "43828455", "43896223", "42898437", "42898162", "42897948", "41069130", "45261382", "43896055", "45261407", "42898681", "43828253", "45261653", "42897743", "45261532", "41125478", "43828142", "42898802", "41048068", "43895865", "43896162", "43828442", "41098149", "45663257", "42899264", "42899177", "43896199", "43828361", "43828514", "42899938", "43896169", "43896247", "42898006", "44358410", "42898980", "42897873", "44358168", "41048251", "42899247", "42899562", "42898236", "45261039", "42899260", "42898242", "42897547", "43896591", "43896256", "42899025", "41048230", "43828402", "42899795", "42898405", "44358392", "41069175", "45261569", "42897462", "42898745", "42897480", "41098110", "45261025", "45662874", "42897671", "42898768", "41098090", "43895910", "41048181", "42898596", "44358368", "42899357", "45662951", "43828562", "40777063", "42899867", "41098086", "43895999", "42897838", "42897736", "43896252", "40958748", "42899770", "42897777", "42898067", "41124899", "43896133", "44358250", "45662839", "43896411", "42899898", "42899259", "43896382", "45662890", "41048247", "42898061", "41069134", "43895947", "43895987", "44358660", "42897871", "42898408", "42898635", "44358707", "42897587", "42899470", "41069077", "42898625", "41069127", "41048240", "42899163", "41048095", "42897990", "42897784", "42898750", "45261413", "44358422", "43896396", "42899870", "42898075", "42898502", "42899869", "42899031", "45260938", "42898695", "41048149", "43828596", "41048103", "42899586", "43896490", "42899780", "43896188", "42898382", "45261073", "43896390", "42898195", "42898210", "42897954", "42898501", "40809740", "43896476", "42899263", "42899072", "41069128", "45663317", "42899599", "43896089", "42899325", "45261060", "41048196", "42899144", "42899531", "43896550", "41125380", "45260976", "43895882", "41098046", "45261390", "41048172", "42898083", "45261072", "44358111", "44358645", "45260946", "42898803", "45662905", "44358474", "45260993", "42899450", "42898141", "43896304", "42897942", "45261358", "41097980", "42897827", "42898068", "45260889", "42898943", "44358274", "41048113", "43896161", "42897994", "42899187", "43828144", "41007589", "42897979", "43896209", "41007613", "42898216", "42899750", "42898449", "41069100", "42897523", "45261457", "42898760", "42898794", "45261502", "44358367", "42898929", "42899250", "42898055", "41125525", "43896426", "42899362", "43896138", "42899284", "43896249", "44358207", "44358397", "42899875", "45261644", "43828282", "41098048", "41098085", "42899670", "41125512", "44358604", "42898448", "41048173", "44358297", "43896097", "42899821", "42898782", "42899030", "41098000", "43896310", "42897409", "45261658", "42898191", "43828254", "42899491", "45662833", "43828441", "43828520", "42898007", "41097985", "43828393", "43896195", "43828449", "42899270", "43828350", "43828362", "42898043", "42899002", "42899540", "45261399", "43828167", "41048249", "45662816", "45663313", "42899814", "41098047", "42897628", "42897732", "45662875", "41069087", "42898434", "42899905", "43896215", "43895863", "43896074", "43895936", "42897857", "42899437", "41125385", "45261499", "42898586", "41098053", "43828437", "42897605", "44358268", "42899440", "42897984", "42897666", "43828463", "41125231", "45261007", "44358647", "41069132", "42899663", "42897907", "45663250", "42898039", "43896009", "43828592", "41069165", "43896404", "42897436", "41098176", "42898343", "43896398", "45662851"
]

class ARKitScenesDataset(BaseDataset):
    def __init__(
        self,
        len_train: int = 50000,
        len_test: int = 5000,
        split: str = "train",
        expand_ratio = 4,
        ARKitScenes_DIR: str = "",
    ):
        """
        Initialize the ARDataset.

        Args:
            split (str): Dataset split, either 'train' or 'test'.
            AR_DIR (str): Directory path to AR data.
            len_train (int): Length of the training dataset.
            len_test (int): Length of the test dataset.
            expand_range (int): Range for expanding nearby image selection.
            get_nearby_thres (int): Threshold for nearby image selection.
        """
        super(ARKitScenesDataset, self).__init__(len_train, len_test, split, expand_ratio)

        self.ARKitScenes_DIR = ARKitScenes_DIR
        logging.info(f"ARKitScenes_DIR is {self.ARKitScenes_DIR}")

        self.sequence_list = seq_list
        self.sequence_list_len = len(self.sequence_list)

        logging.info(f"{self.status}: ARKitScenes Real Data size: {self.sequence_list_len}")
        logging.info(f"{self.status}: ARKitScenes Data dataset length: {len(self)}")

        # meta datas
        with open(osp.join(self.ARKitScenes_DIR, 'image2intrinsics_map.pkl'), 'rb') as f:
            self.image2intrinsics_map = pickle.load(f)
        with open(osp.join(self.ARKitScenes_DIR, 'image2pose_map.pkl'), 'rb') as f:
            self.image2pose_map = pickle.load(f)

    def __getitem__(
        self,
        seq_index: int = None,
        img_per_seq: int = 8,
    ) -> dict:
        """
        Retrieve data for a specific sequence.

        Args:
            seq_index (int): Index of the sequence to retrieve.
            img_per_seq (int): Number of images per sequence.
            aspect_ratio (float): Aspect ratio for image processing.

        Returns:
            dict: A batch of data including images, depths, and other metadata.
        """
        seq_index = seq_index % self.sequence_list_len
        seq_name = self.sequence_list[seq_index % self.sequence_list_len]
        img_dir = os.path.join(self.ARKitScenes_DIR, seq_name, 'vga_wide')
        available_images = sorted(glob.glob(osp.join(img_dir, "*.jpg")))
        num_images = len(available_images)

        ids = np.random.choice(num_images, img_per_seq, replace=self.allow_duplicate_img)
        if self.get_nearby:
            ids = self.get_nearby_ids(ids, num_images, expand_ratio=self.expand_ratio)

        target_image_shape = np.array([224, 224])
        images = []
        images_paths = []
        depths = []
        cam_points = []
        world_points = []
        point_masks = []
        extrinsics = []
        intrinsics = []
        original_sizes = []

        for view_index in ids:

            impath = available_images[view_index]
            basename = osp.basename(impath)

            
            # image
            image = imread_cv2(impath)

            # intrinscis and extrinsics (opencv format)
            intri_opencv = self.image2intrinsics_map[basename.replace('jpg', 'png')]
            camera_pose = self.image2pose_map[basename.replace('jpg', 'png')]
            extri_opencv = closed_form_inverse_se3(camera_pose[None])[0][:3, :] # w2c
            
            # depth map
            depthpath = impath.replace("vga_wide", "lowres_depth").replace("jpg", "png")
            depth_map = imread_cv2(depthpath, cv2.IMREAD_UNCHANGED)
            depth_map = depth_map.astype(np.float32) / 1000
            depth_map[~np.isfinite(depth_map)] = 0  # invalid

            assert image.shape[:2] == depth_map.shape, f"Image and depth shape mismatch: {image.shape[:2]} vs {depth_map.shape}"

            original_size = np.array(image.shape[:2])

            (
                image,
                depth_map,
                extri_opencv,
                intri_opencv,
                world_coords_points,
                cam_coords_points,
                point_mask,
                _,
            ) = self.process_one_image(
                image,
                depth_map,
                extri_opencv,
                intri_opencv,
                original_size,
                target_image_shape,
                filepath=impath,
            )

            if (image.shape[:2] != target_image_shape).any():
                logging.error(f"Wrong shape for {seq_name}: expected {target_image_shape}, got {image.shape[:2]}")
                continue

            images.append(image)
            images_paths.append(impath)
            depths.append(depth_map)
            extrinsics.append(extri_opencv)
            intrinsics.append(intri_opencv)
            cam_points.append(cam_coords_points)
            world_points.append(world_coords_points)
            point_masks.append(point_mask)
            original_sizes.append(original_size)

        set_name = "ARKitScenes"
        batch = {
            "seq_name": set_name + "_" + seq_name,
            "ids": ids,
            "frame_num": len(extrinsics),
            "images": images,
            "images_paths": images_paths,
            "depths": depths,
            "extrinsics": extrinsics,
            "intrinsics": intrinsics,
            "cam_points": cam_points,
            "world_points": world_points,
            "point_masks": point_masks,
            "original_sizes": original_sizes,
        }

        sample = self.post_processing(batch)

        return sample

if __name__ == "__main__":
    dataste = ARKitScenesDataset()
    print(dataste[0])